# DyGenePT Configuration

# ========================
# Paths
# ========================
paths:
  gene_info: "data/Homo_sapiens_gene_info_with_go_and_pathways.tsv"
  facet_output: "data/gene_facets.jsonl"           # step1 输出
  facet_embeddings: "data/gene_facet_embeddings.pt" # step2 输出
  perturb_data_dir: "data/perturb_data"
  scgpt_checkpoint: "checkpoints/scgpt/whole_human"
  output_dir: "outputs"
  kg_dir: "data/kg"                                # 知识图谱数据目录

# ========================
# LLM API (Module 1 - Facet Decomposition)
# ========================
llm:
  base_url: "https://yunwu.ai/v1"
  api_key: "${oc.env:LLM_API_KEY}"    # 从环境变量读取
  model: "gemini-3-pro-preview"
  temperature: 0.3
  max_tokens: 8192
  batch_size: 32                       # 并发请求数
  retry_max: 3
  retry_delay: 2

# ========================
# Facets Definition
# ========================
facets:
  num_facets: 8
  names:
    - "Transcriptional Regulation"
    - "Cell Cycle & Proliferation"
    - "Cell Death & Survival"
    - "Metabolic Processes"
    - "Immune Response"
    - "Signal Transduction"
    - "Cell Motility & Adhesion"
    - "Transport & Localization"

# ========================
# Embedding Model (Module 1 - Text Encoding)
# ========================
# backend: "local" = HuggingFace model, "api" = remote /v1/embeddings
embedding:
  backend: "local"
  # --- local backend ---
  model_name: "FremyCompany/BioLORD-2023-M"
  pooling: "mean"                    # mean / cls
  max_length: 256
  # --- api backend (used when backend=api) ---
  api:
    base_url: "https://api.siliconflow.cn/v1"
    api_key: "${oc.env:EMBED_API_KEY}"
    model: "Qwen/Qwen3-Embedding-8B"
    dimensions: 768                   # Qwen3 supports 64~4096, set 768 to align downstream
    batch_limit: 32                   # SiliconFlow max 32 per request
    concurrency: 8                    # async concurrent requests
    retry_max: 3
    retry_delay: 2
  # --- common ---
  batch_size: 64
  embed_dim: 768

# ========================
# Cell Encoder (Module 2 - scGPT)
# ========================
cell_encoder:
  model_name: "scGPT"
  embed_dim: 512
  freeze_layers: -2        # 冻结除最后 2 层外的所有层
  max_seq_len: 3000         # 最大基因数

# ========================
# Cross-Attention (Module 3)
# ========================
cross_attention:
  num_heads: 8
  hidden_dim: 768           # 与 PubMedBERT 维度对齐
  dropout: 0.1

# ========================
# Perturbation Decoder (Module 4)
# ========================
decoder:
  hidden_dims: [512, 256]
  dropout: 0.1
  use_gene_graph: false      # GO graph (未实现，保留为扩展项)
  num_go_layers: 2

# ========================
# Training
# ========================
training:
  dataset: "norman"           # norman / adamson / dixit / replogle_k562_essential / replogle_rpe1_essential
  seed: 42
  epochs: 20
  batch_size: 64
  lr: 1.0e-4
  weight_decay: 1.0e-5
  scheduler: "cosine"
  warmup_steps: 500
  gradient_clip: 1.0
  eval_every: 1               # 每 N 个 epoch 评估
  save_best: true
  early_stopping_patience: 5
  loss:
    mse_weight: 1.0
    de_mse_weight: 0.5           # DE-focused MSE on top DE genes
    direction_weight: 0.1     # top DE genes direction loss
  # Cross-validation settings (for K562/RPE1 LangPert comparison)
  cross_validation:
    enabled: false             # 设为 true 启用 K-fold CV
    n_folds: 5                 # LangPert 使用 5-fold CV
    split_mode: "simulation"   # simulation / cross_validation

# ========================
# Dataset-specific settings
# ========================
dataset_configs:
  norman:
    data_name: "norman"
    split_mode: "simulation"         # GEARS simulation split (unseen combos)
    single_gene_only: false          # 包含组合扰动
  replogle_k562_essential:
    data_name: "replogle_k562_essential"
    split_mode: "simulation"         # 单基因只有 simulation 模式
    single_gene_only: true           # LangPert 仅评估单基因
  replogle_rpe1_essential:
    data_name: "replogle_rpe1_essential"
    split_mode: "simulation"         # 单基因只有 simulation 模式
    single_gene_only: true           # LangPert 仅评估单基因

# ========================
# Evaluation
# ========================
evaluation:
  top_de_genes: 20            # 评估 top N DE genes
  metrics:
    - "mse"
    - "mae"
    - "pearson_top20"
    - "pearson_delta_top20"
    - "direction_accuracy"

# ========================
# KG Text Enrichment (Step 1.5)
# ========================
kg_enrichment:
  enabled: true
  string_evidence_filter:      # STRING 证据类型过滤
    - "experiments"
    - "database"
  max_neighbors: 5             # 每个基因最多取几个 PPI 邻居描述

# ========================
# KG Facet Imputation (Step 4)
# ========================
imputation:
  enabled: true
  max_neighbors: 20            # 搜索邻居的最大数量
  min_informed_neighbors: 2    # 第1轮至少需要几个邻居（后续轮降为1）
  confidence_cap: 0.8          # 补全 facet 的最大置信度（原生=1.0）
  num_rounds: 3                # 迭代传播轮数（每轮用上轮结果继续填充）
  evidence_weights:            # STRING 证据类型权重
    experiments: 1.0
    database: 0.8
    experiments_transferred: 0.5
    textmining: 0.3
    textmining_transferred: 0.2
